server:
  port: 8443
  ssl:
    enabled: true
    key-store: classpath:keystore.jks
    key-store-password: password
    key-password: password
    key-alias: apigateway
    key-store-type: JKS

spring:
  application:
    name: api-gateway
  cloud:
    gateway:
      routes:
        # 用户认证服务路由
        - id: user-auth-service
          uri: lb://user-auth-service
          predicates:
            - Path=/api/user/**
          filters:
            - StripPrefix=2
            - name: RateLimit
              args:
                limit: 5
                refreshInterval: 1
            - name: Ip
              args:
                whitelist:
                  - 127.0.0.1
                  - 192.168.1.0/24
                blacklist:
                  - 10.0.0.1
            - name: RequestValidation
              args:
                requiredHeaders:
                  - User-Agent
                requiredParams:
                  - timestamp
            - name: CircuitBreaker
              args:
                name: userAuthServiceCircuitBreaker
                fallbackUri: forward:/fallback/user
            - name: ApiKey
              args:
                required: true

        # 资源服务路由
        - id: resource-service
          uri: lb://resource-service
          predicates:
            - Path=/api/resources/**
          filters:
            - StripPrefix=2
            - name: RateLimit
              args:
                limit: 5
                refreshInterval: 1
            - name: Ip
              args:
                whitelist:
                  - 127.0.0.1
                  - 192.168.1.0/24
                blacklist:
                  - 10.0.0.1
            - name: CircuitBreaker
              args:
                name: resourceServiceCircuitBreaker
                fallbackUri: forward:/fallback/resource
            - name: ApiKey
              args:
                required: true

        # 化学内容服务路由
        - id: chemistry-content-service
          uri: lb://chemistry-content-service
          predicates:
            - Path=/api/chemistry/**
          filters:
            - StripPrefix=2
            - name: RateLimit
              args:
                limit: 10
                refreshInterval: 1
            - name: Ip
              args:
                whitelist:
                  - 127.0.0.1
                  - 192.168.1.0/24
                blacklist:
                  - 10.0.0.1
            - name: CircuitBreaker
              args:
                name: chemistryContentServiceCircuitBreaker
                fallbackUri: forward:/fallback/chemistry
            - name: ApiKey
              args:
                required: true

        # 答题服务路由
        - id: quiz-service
          uri: lb://quiz-service
          predicates:
            - Path=/api/quiz/**
          filters:
            - StripPrefix=2
            - name: RateLimit
              args:
                limit: 10
                refreshInterval: 1
            - name: Ip
              args:
                whitelist:
                  - 127.0.0.1
                  - 192.168.1.0/24
                blacklist:
                  - 10.0.0.1
            - name: CircuitBreaker
              args:
                name: quizServiceCircuitBreaker
                fallbackUri: forward:/fallback/quiz
            - name: ApiKey
              args:
                required: true

        # 奖励服务路由
        - id: reward-service
          uri: lb://reward-service
          predicates:
            - Path=/api/reward/**
          filters:
            - StripPrefix=2
            - name: RateLimit
              args:
                limit: 5
                refreshInterval: 1
            - name: Ip
              args:
                whitelist:
                  - 127.0.0.1
                  - 192.168.1.0/24
                blacklist:
                  - 10.0.0.1
            - name: CircuitBreaker
              args:
                name: rewardServiceCircuitBreaker
                fallbackUri: forward:/fallback/reward
            - name: ApiKey
              args:
                required: true

        # 学习服务路由
        - id: learning-service
          uri: lb://learning-service
          predicates:
            - Path=/api/learning/**
          filters:
            - StripPrefix=2
            - name: RateLimit
              args:
                limit: 8
                refreshInterval: 1
            - name: Ip
              args:
                whitelist:
                  - 127.0.0.1
                  - 192.168.1.0/24
                blacklist:
                  - 10.0.0.1
            - name: CircuitBreaker
              args:
                name: learningServiceCircuitBreaker
                fallbackUri: forward:/fallback/learning
            - name: ApiKey
              args:
                required: true
        # 任务管理服务路由
        - id: task-management-service
          uri: lb://task-management-service
          predicates:
            - Path=/api/tasks/**
          filters:
            - StripPrefix=2
            - name: RateLimit
              args:
                limit: 5
                refreshInterval: 1
            - name: Ip
              args:
                whitelist:
                  - 127.0.0.1
                  - 192.168.1.0/24
                blacklist:
                  - 10.0.0.1
            - name: CircuitBreaker
              args:
                name: taskManagementServiceCircuitBreaker
                fallbackUri: forward:/fallback/task-management
            - name: ApiKey
              args:
                required: true

eureka:
  client:
    serviceUrl:
      defaultZone: http://localhost:8761/eureka/
    # 启用健康检查
    healthcheck:
      enabled: true
  instance:
    prefer-ip-address: true
    # 服务续约间隔
    lease-renewal-interval-in-seconds: 30
    # 服务过期时间
    lease-expiration-duration-in-seconds: 90
    # 实例ID
    instance-id: ${spring.cloud.client.hostname}:${spring.application.name}:${server.port}

# 监控配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
  metrics:
    tags:
      application: ${spring.application.name}

# Resilience4j 配置
resilience4j:
  circuitbreaker:
    instances:
      userAuthServiceCircuitBreaker:
        registerHealthIndicator: true
        slidingWindowSize: 100
        minimumNumberOfCalls: 10
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 60s
        failureRateThreshold: 50
        eventConsumerBufferSize: 10
      resourceServiceCircuitBreaker:
        registerHealthIndicator: true
        slidingWindowSize: 100
        minimumNumberOfCalls: 10
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 60s
        failureRateThreshold: 50
        eventConsumerBufferSize: 10
      chemistryContentServiceCircuitBreaker:
        registerHealthIndicator: true
        slidingWindowSize: 100
        minimumNumberOfCalls: 10
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 60s
        failureRateThreshold: 50
        eventConsumerBufferSize: 10
      quizServiceCircuitBreaker:
        registerHealthIndicator: true
        slidingWindowSize: 100
        minimumNumberOfCalls: 10
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 60s
        failureRateThreshold: 50
        eventConsumerBufferSize: 10
      rewardServiceCircuitBreaker:
        registerHealthIndicator: true
        slidingWindowSize: 100
        minimumNumberOfCalls: 10
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 60s
        failureRateThreshold: 50
        eventConsumerBufferSize: 10
      learningServiceCircuitBreaker:
        registerHealthIndicator: true
        slidingWindowSize: 100
        minimumNumberOfCalls: 10
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 60s
        failureRateThreshold: 50
        eventConsumerBufferSize: 10
      taskManagementServiceCircuitBreaker:
        registerHealthIndicator: true
        slidingWindowSize: 100
        minimumNumberOfCalls: 10
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 60s
        failureRateThreshold: 50
        eventConsumerBufferSize: 10